<script>
    const displayText = document.getElementById('displayText');
    let recognition;

    // Speech Synthesis (အသံပြန်ထွက်ရန်)
    function speak(text, langCode) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = langCode;
        window.speechSynthesis.speak(utterance);
    }

    async function startTranslate(inputLang, targetLang) {
        if (!('webkitSpeechRecognition' in window)) {
            alert("Chrome Browser ကို အသုံးပြုပေးပါ။");
            return;
        }

        // ရှိပြီးသား recognition ရှိရင် ရပ်လိုက်ပါ
        if (recognition) {
            recognition.stop();
        }

        recognition = new webkitSpeechRecognition();
        recognition.lang = inputLang;
        recognition.continuous = false; // စကားပြောပြီးရင် အလိုအလျောက် ရပ်စေရန်
        recognition.interimResults = false; // နောက်ဆုံးရလဒ်ကိုပဲ ယူရန်

        const activeBtn = inputLang === 'my-MM' ? document.getElementById('btnMM') : document.getElementById('btnTH');
        
        // UI အပြောင်းအလဲ
        activeBtn.classList.add('listening');
        displayText.innerText = "... နားထောင်နေသည် ...";

        recognition.onstart = () => {
            console.log("Mic is active");
        };

        recognition.onresult = async (event) => {
            const transcript = event.results[0][0].transcript;
            displayText.innerText = "ဘာသာပြန်နေသည်...";

            try {
                const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=${inputLang.split('-')[0]}&tl=${targetLang}&dt=t&q=${encodeURI(transcript)}`);
                const data = await res.json();
                const translatedText = data[0][0][0];

                displayText.innerHTML = `<div style="font-size: 18px; color: #888; margin-bottom:10px;">${transcript}</div><div><b>${translatedText}</b></div>`;
                
                speak(translatedText, targetLang === 'th' ? 'th-TH' : 'my-MM');
            } catch (error) {
                displayText.innerText = "Error ဖြစ်သွားပါသည်။ ပြန်ကြိုးစားပါ။";
            }
        };

        recognition.onerror = (event) => {
            console.error("Speech Recognition Error: ", event.error);
            if (event.error === 'not-allowed') {
                alert("Microphone Permission ပေးရန် လိုအပ်ပါသည်။");
            }
            activeBtn.classList.remove('listening');
            displayText.innerText = "Error: " + event.error;
        };

        recognition.onend = () => { 
            activeBtn.classList.remove('listening'); 
        };

        recognition.start();
    }
</script>

